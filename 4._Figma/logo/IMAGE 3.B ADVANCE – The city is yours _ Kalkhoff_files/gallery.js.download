define([
    'jquery',
    'slick'
], function ($, slick) {
    'use strict';

    $.widget('mage.pdpGallery', {
        options: {
            carouselSelector: '.product-gallery__items--main',
            thumbsSelector: '.product-gallery__thumbnails--main',
            modalCarouselSelector: '.product-gallery__items--modal',
            modalThumbsSelector: '.product-gallery__thumbnails--modal',
            hiddenThumbsClass: 'product-gallery__thumbnails--hidden',
            modalSelectorId: 'product-gallery-modal',
            modalTriggersAttribute: 'galleryModalTrigger',
            modalVisibleClass: 'visible',
            openModalBodyClass: 'modal-open'
        },

        _create: function () {
            this.initElements();
            this.initSlickSliders();
            this.initModalTriggers();
        },

        initElements: function () {
            this.$gallery = this.element.find(this.options.carouselSelector);
            this.$thumbnails = this.element.find(this.options.thumbsSelector);
            this.$modalGallery = this.element.find(this.options.modalCarouselSelector);
            this.$modalThumbnails = this.element.find(this.options.modalThumbsSelector);
            this.$modal = document.getElementById(this.options.modalSelectorId);
        },

        initModalTriggers: function () {
            let self = this;

            document.addEventListener('click', (e) => {
                if (e.target.dataset.hasOwnProperty(self.options.modalTriggersAttribute)) {
                    self.toggleModal();
                }
            });

            document.addEventListener('keyup', (e) => {
                if (
                    document.querySelector('body').classList.contains(self.options.openModalBodyClass)
                    && self.$modal.classList.contains(self.options.modalVisibleClass)
                    && e.key === "Escape"
                ) {
                    self.toggleModal();
                }
            });
        },

        toggleModal: function () {
            let self = this;

            self.$modal.classList.toggle(self.options.modalVisibleClass);
            document.querySelector('body').classList.toggle(self.options.openModalBodyClass);

            if (!document.querySelector('body').classList.contains(self.options.openModalBodyClass)) {
                $(self.$gallery).slick('slickGoTo', 0, true);
            }
        },

        initSlickSliders: function () {
            let self = this;

            let allSliderSelectors = `${self.options.thumbsSelector}, ${self.options.modalThumbsSelector}, ${self.options.carouselSelector}, ${self.options.modalCarouselSelector}`;
            let carouselConfig = {
                arrows: false,
                infinite: false,
                slidesToShow: 1,
                slidesToScroll: 1,
                asNavFor: allSliderSelectors,
            };
            let thumbsConfig = {
                slidesToShow: 3,
                slidesToScroll: 1,
                infinite: false,
                centerMode: true,
                focusOnSelect: true,
                variableWidth: true,
                asNavFor: allSliderSelectors,
                prevArrow: '<a href="#" class="slick-arrow-prev"></a>',
                nextArrow: '<a href="#" class="slick-arrow-next"></a>',
            };

            $(self.$gallery).slick(carouselConfig).on('init', () => self.initModalTriggers());
            $(self.$thumbnails).slick(thumbsConfig).on('reInit', (event, slick) => self.hideThumbnails(event, slick));
            $(self.$modalGallery).slick(carouselConfig);
            $(self.$modalThumbnails).slick(thumbsConfig).on('reInit', (event, slick) => self.hideThumbnails(event, slick));

            let slickGallery = $('.product-gallery__items--main').slick('getSlick'),
                slickModalGallery = $('.product-gallery__items--modal').slick('getSlick'),
                slickGalleryThumbs = $('.product-gallery__thumbnails--main').slick('getSlick'),
                slickModalGalleryThumbs = $('.product-gallery__thumbnails--modal').slick('getSlick'),
                simpleId = $(slickGallery.$slides.get(0)).data('simples');

            [slickGallery, slickModalGallery, slickGalleryThumbs, slickModalGalleryThumbs].map(slickGallery => {
                slickGallery.slickUnfilter();
                slickGallery.slickFilter(`[data-simples*="${simpleId}"]`);
            });
        },

        hideThumbnails: function(event, slick) {
            event.target.classList.toggle(this.options.hiddenThumbsClass, slick.slideCount === 1);
        },
    });

    return $.mage.pdpGallery;
});
